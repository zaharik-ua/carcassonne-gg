<!-- ШРИФТ + ІКОНКИ -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- СТИЛІ -->
<style>
  body {
    font-family: 'Montserrat', sans-serif;
  }

  .section-title {
    font-size: 20px;
    font-weight: 700;
    color: #222;
    margin: 15px 0 6px 0;
    padding: 0 8px;
  }

  .filter-title {
    font-size: 16px;
    font-weight: 600;
    color: #222;
    margin: 6px 0 4px 0;
    padding: 0 8px;
  }

  .filter-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 8px 4px;
  }

  .clear-filters-button {
    font-size: 12px;
    cursor: pointer;
    padding: 2px 6px;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 3px;
    height: 20px;
    line-height: 16px;
    transition: all 0.2s ease;
  }

  .clear-filters-button:hover {
    border-color: #0277BD;
    box-shadow: 0 0 3px rgba(2, 119, 189, 0.4);
  }

  .count-display {
    font-size: 14px;
    color: #333333;
  }

  .count-display .label,
  .count-display .value {
    font-size: 14px;
    color: #333333;
  }

  .count-display .label {
    font-weight: 400;
  }

  .count-display .value {
    font-weight: 600;
  }

  .tournament-card {
    background: white;
    border-radius: 4px;
    box-shadow: 1.4px 1.4px 2px #b2b2b2;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .player-row {
    display: flex;
    align-items: stretch;
    justify-content: space-between;
    padding: 6px 8px;
    background-color: white;
    border-top: 1px solid #ccc;
    box-sizing: border-box;
  }

  .player-left {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    min-width: 0;
    flex: 1 1 auto;
  }

  .player-flag {
    width: 20px;
    height: 20px;
    object-fit: contain;
  }

  .player-text {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
  }

  .player-nick a {
    font-size: 16px;
    font-weight: normal;
    text-decoration: none;
    color: #333333;
    transition: color 0.2s ease;
  }

  .player-nick a:hover {
    color: #0277BD;
  }

  .player-name {
    font-size: 14px;
    color: #555;
  }

  .player-achievements {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
  }

  .player-achievements img {
    height: 20px;
    margin-left: 4px;
  }

  .player-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    white-space: nowrap;
  }

  .elo-rating {
    color: #fff;
    background-color: #b593c4;
    font-weight: bold;
    font-size: 12px;
    border-radius: 2px;
    height: auto;
    padding: 3px 5px;
    line-height: 1;
    margin-top: 0px;
    white-space: nowrap;
  }
  .gamerank_beginner { background-color: #74bed1; }
  .gamerank_average { background-color: #84b8de; }
  .gamerank_good { background-color: #94acd6; }
  .gamerank_strong { background-color: #9ba5d0; }
  .gamerank_expert { background-color: #a99bc9; }
  .gamerank_master { background-color: #b593c4; }

  .player-date {
    font-size: 14px;
  }

  #flag-filter-wrapper,
  #type-filter-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
    margin-bottom: 4px;
    padding-left: 8px;
  }

  #flag-filter-wrapper img {
    width: 24px;
    height: 24px;
    cursor: pointer;
    border-radius: 3px;
    border: 2px solid transparent;
    transition: border 0.2s ease;
  }

  #flag-filter-wrapper img.active {
    border-color: #0277BD;
  }

  .type-filter-option {
    font-size: 12px;
    cursor: pointer;
    padding: 2px 6px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background-color: #fffde5;
    color: #333;
    transition: all 0.2s ease;
  }

  .type-filter-option.active {
    border-color: #0277BD;
    background-color: #fbf092;
  }

  /* Masters table */
  .masters-table {
    width: 100%;
    border-collapse: collapse;
  }
  .masters-table thead th {
    text-align: left;
    font-size: 15px;
    line-height: 17px;
    font-weight: 600;
    padding: 8px;
    border-bottom: 1px solid #ccc;
    background: #fafafa;
    white-space: normal;
    word-break: break-word;
  }
  .masters-table thead th.col-elo,
  .masters-table thead th.col-peak {
    text-align: center;
    /* Ensure these columns also wrap and break words */
    white-space: normal;
    word-break: normal;
  }
  /* Make Peak column header interactive and highlight when sorted */
  .masters-table thead th.col-peak { cursor: pointer; }
  .masters-table thead th.col-peak.sorted { background: #e3f2fd; }
  .masters-table tbody td {
    padding: 6px 8px;
    border-top: 1px solid #ccc;
    vertical-align: middle;
    background: #fff;
  }
  .masters-table .col-player {
    width: 100%;
  }
  .masters-table .col-elo,
  .masters-table .col-peak {
    white-space: nowrap;
    text-align: center;
  }
  .masters-table .col-profile {
    width: 36px;
    text-align: center;
    white-space: nowrap;
  }
  .player-cell {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .player-cell .player-text { line-height: 1.1; }
  .player-cell .player-nick a { font-size: 16px; font-weight: normal; text-decoration: none; color: #333; transition: color .2s ease; }
  .player-cell .player-nick a:hover { color: #0277BD; }
  .player-cell .player-name { font-size: 14px; color: #555; }
  .player-cell .player-achievements img { height: 20px; margin-left: 4px; }
</style>

<div class="section-title">BGA Carcassonne Masters</div>
<div class="filter-title">Country</div>
<div id="flag-filter-wrapper"></div>
<div class="filter-title">Achievements</div>
<div id="type-filter-wrapper"></div>
<div class="filter-row">
  <button class="clear-filters-button" onclick="clearAllFilters()">Clear filters</button>
  <div class="count-display"><span class="label">Count: </span><span class="value" id="player-count"></span></div>
</div>
<div id="players-container"></div>

<script>
  let allPlayers = [];
  let selectedCountry = null;
  let selectedAchievementType = null;
  let allAchievementTypes = [];
  let achievementMap = new Map();
  let sortByPeakActive = false; // controls sorting by 2025 Peak column

  function updatePlayerCount(count) {
    document.getElementById("player-count").textContent = count;
  }

  function clearAllFilters() {
    selectedCountry = null;
    selectedAchievementType = null;
    document.querySelectorAll("#flag-filter-wrapper img").forEach(i => i.classList.remove("active"));
    document.querySelectorAll(".type-filter-option").forEach(b => b.classList.remove("active"));
    renderFilteredPlayers();
  }

  function createPlayerElement(player) {
    const tr = document.createElement("tr");

    // Player column
    const tdPlayer = document.createElement("td");
    tdPlayer.className = "col-player";

    const playerCell = document.createElement("div");
    playerCell.className = "player-cell";

    if (player.flag && String(player.flag).trim() !== "") {
      const flag = document.createElement("img");
      flag.className = "player-flag";
      flag.src = player.flag;
      flag.alt = "flag";
      playerCell.appendChild(flag);
    }

    const textContainer = document.createElement("div");
    textContainer.className = "player-text";

    const nick = document.createElement("div");
    nick.className = "player-nick";
    const nickLink = document.createElement("a");
    nickLink.href = `https://boardgamearena.com/player?id=${player.id}`;
    nickLink.target = "_blank";
    nickLink.textContent = player.player;
    nick.appendChild(nickLink);

    const name = document.createElement("div");
    name.className = "player-name";
    name.textContent = player.name || "";

    textContainer.appendChild(nick);
    if (player.name) textContainer.appendChild(name);
    playerCell.appendChild(textContainer);

    if (player.achievements && player.achievements.length > 0) {
      const achievementsDiv = document.createElement("div");
      achievementsDiv.className = "player-achievements";
      player.achievements.forEach(name => {
        const info = achievementMap.get(name);
        if (info && info.logo_url) {
          const img = document.createElement("img");
          img.src = info.logo_url;
          img.alt = name;
          img.title = name;
          achievementsDiv.appendChild(img);
        }
      });
      playerCell.appendChild(achievementsDiv);
    }

    tdPlayer.appendChild(playerCell);
    tr.appendChild(tdPlayer);

    // Top Elo column (or master_title_date) — with range-based background
    const tdElo = document.createElement("td");
    tdElo.className = "col-elo";
    {
      const rawTop = (player.top_elo ?? "").toString().trim();
      if (rawTop !== "") {
        const val = Number(rawTop);
        if (Number.isFinite(val)) {
          const codeEl = document.createElement("code");
          codeEl.classList.add("elo-rating");
          if (val < 100) codeEl.classList.add("gamerank_beginner");
          else if (val < 200) codeEl.classList.add("gamerank_average");
          else if (val < 300) codeEl.classList.add("gamerank_good");
          else if (val < 500) codeEl.classList.add("gamerank_strong");
          else if (val < 700) codeEl.classList.add("gamerank_expert");
          else codeEl.classList.add("gamerank_master");
          codeEl.textContent = `${val}`;
          tdElo.appendChild(codeEl);
        } else {
          // Non-numeric value present → show plain text (no background)
          const span = document.createElement("span");
          span.textContent = rawTop;
          tdElo.appendChild(span);
        }
      } else if (player.master_title_date) {
        const date = document.createElement("div");
        date.className = "player-date";
        date.textContent = player.master_title_date;
        tdElo.appendChild(date);
      } else {
        tdElo.textContent = "";
      }
    }
    tr.appendChild(tdElo);

    // 2025 Peak Elo column
    const tdPeak = document.createElement("td");
    tdPeak.className = "col-peak";
    {
      const rawPeak = (player.peak_elo_2025 ?? "").toString().trim();
      const val = Number(rawPeak);
      if (rawPeak !== "" && Number.isFinite(val)) {
        const codeEl = document.createElement("code");
        codeEl.classList.add("elo-rating");
        if (val < 100) codeEl.classList.add("gamerank_beginner");
        else if (val < 200) codeEl.classList.add("gamerank_average");
        else if (val < 300) codeEl.classList.add("gamerank_good");
        else if (val < 500) codeEl.classList.add("gamerank_strong");
        else if (val < 700) codeEl.classList.add("gamerank_expert");
        else codeEl.classList.add("gamerank_master");
        codeEl.textContent = `${val}`;
        tdPeak.appendChild(codeEl);
      } else if (rawPeak) {
        // Non-numeric value present → show as plain text (no background)
        const span = document.createElement("span");
        span.textContent = rawPeak;
        tdPeak.appendChild(span);
      } else {
        tdPeak.textContent = "";
      }
    }
    tr.appendChild(tdPeak);

    // Profile icon column (no header)
    const tdProfile = document.createElement("td");
    tdProfile.className = "col-profile";
    if (player.profile) {
      const link = document.createElement("a");
      link.href = player.profile;
      link.target = "_blank";
      link.innerHTML = '<i class="fas fa-user" style="font-size: 14px;"></i>';
      tdProfile.appendChild(link);
    }
    tr.appendChild(tdProfile);

    return tr;
  }

  function renderPlayersSection(container, title, players) {
    if (!players || players.length === 0) return;
    updatePlayerCount(players.length);

    const card = document.createElement("div");
    card.className = "tournament-card";

    const table = document.createElement("table");
    table.className = "masters-table";

    const thead = document.createElement("thead");
    const hr = document.createElement("tr");

    const thPlayer = document.createElement("th");
    thPlayer.textContent = "Player";
    hr.appendChild(thPlayer);

    const thTopElo = document.createElement("th");
    thTopElo.className = "col-elo";
    thTopElo.textContent = "Top Elo";
    hr.appendChild(thTopElo);

    // Make Peak column header clickable and highlight when active
    const thPeak = document.createElement("th");
    thPeak.className = "col-peak";
    thPeak.textContent = "2025 Peak*";
    if (sortByPeakActive) thPeak.classList.add("sorted");
    thPeak.addEventListener("click", () => {
      sortByPeakActive = !sortByPeakActive;
      renderFilteredPlayers();
    });
    hr.appendChild(thPeak);

    const thProfile = document.createElement("th");
    thProfile.textContent = ""; // profile icon column (no header label)
    hr.appendChild(thProfile);

    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    players.forEach(player => tbody.appendChild(createPlayerElement(player)));
    table.appendChild(tbody);

    card.appendChild(table);
    container.appendChild(card);

    // Add note after the table card
    const note = document.createElement("div");
    note.textContent = "* player's peak Elo in 2025 (updated on 21/08/2025)";
    container.appendChild(note);
  }

  function renderFilteredPlayers() {
    let filtered = [...allPlayers];
    if (selectedCountry) {
      filtered = filtered.filter(p => p.country === selectedCountry);
    }
    if (selectedAchievementType) {
      filtered = filtered.filter(p => {
        return p.achievements?.some(a => {
          const info = achievementMap.get(a);
          return info?.type === selectedAchievementType;
        });
      });
    }

    if (sortByPeakActive) {
      // Sort by 2025 Peak: numeric values first (desc), then non-numeric by player name
      filtered.sort((a, b) => {
        const aRaw = (a.peak_elo_2025 ?? "").toString().trim();
        const bRaw = (b.peak_elo_2025 ?? "").toString().trim();
        const aNum = Number(aRaw);
        const bNum = Number(bRaw);
        const aIsNum = Number.isFinite(aNum);
        const bIsNum = Number.isFinite(bNum);

        if (aIsNum && bIsNum) return bNum - aNum; // desc
        if (aIsNum) return -1;  // numeric first
        if (bIsNum) return 1;   // numeric first

        return a.player.localeCompare(b.player);
      });
    } else {
      // Base sorting (existing behavior)
      filtered.sort((a, b) => {
        const eloA = a.top_elo || 0;
        const eloB = b.top_elo || 0;

        if (eloA && eloB) return eloB - eloA; // sort by elo if both exist
        if (eloA) return -1; // a has elo, b — not
        if (eloB) return 1;  // b has elo, a — not

        const hasDateA = !!a.master_title_date;
        const hasDateB = !!b.master_title_date;

        if (hasDateA && hasDateB) {
          const dateA = new Date(a.master_title_date.split('.').reverse().join('-'));
          const dateB = new Date(b.master_title_date.split('.').reverse().join('-'));
          return dateA - dateB; // from oldest to newest
        }
        if (hasDateA) return -1; // a has date
        if (hasDateB) return 1;  // b has date

        return a.player.localeCompare(b.player); // fallback by nickname
      });
    }

    const container = document.getElementById("players-container");
    container.innerHTML = "";
    renderPlayersSection(container, "BGA Carcassonne Masters", filtered);
  }

  function setupCountryFlags(players) {
    const countries = [...new Map(players.map(p => [p.country, p.flag])).entries()]
      .sort((a, b) => a[0].localeCompare(b[0]));

    const wrapper = document.getElementById("flag-filter-wrapper");
    wrapper.innerHTML = "";

    countries.forEach(([country, flagUrl]) => {
      const img = document.createElement("img");
      img.src = flagUrl;
      img.alt = country;
      img.title = country;
      img.addEventListener("click", () => {
        if (selectedCountry === country) {
          selectedCountry = null;
          img.classList.remove("active");
        } else {
          selectedCountry = country;
          wrapper.querySelectorAll("img").forEach(i => i.classList.remove("active"));
          img.classList.add("active");
        }
        renderFilteredPlayers();
      });
      wrapper.appendChild(img);
    });
  }

  function setupAchievementTypeFilter(types) {
    const wrapper = document.getElementById("type-filter-wrapper");
    wrapper.innerHTML = "";

    types.forEach(type => {
      const btn = document.createElement("div");
      btn.className = "type-filter-option";
      btn.textContent = type;
      btn.addEventListener("click", () => {
        if (selectedAchievementType === type) {
          selectedAchievementType = null;
          btn.classList.remove("active");
        } else {
          selectedAchievementType = type;
          wrapper.querySelectorAll(".type-filter-option").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        }
        renderFilteredPlayers();
      });
      wrapper.appendChild(btn);
    });
  }

async function fetchAndRenderPlayers() {
  // Load only from local JSON files
  const playersURL = "https://zaharik-ua.github.io/carcassonne-gg/json-data/masters.json";
  const achievementsURL = "https://zaharik-ua.github.io/carcassonne-gg/json-data/achievements.json";

  try {
    const [playersRes, achievementsRes] = await Promise.all([
      fetch(playersURL),
      fetch(achievementsURL)
    ]);
    if (!playersRes.ok || !achievementsRes.ok) {
      throw new Error("Failed to load JSON files");
    }

    const playersData = await playersRes.json();
    const achievementsData = await achievementsRes.json();

    allPlayers = playersData.masters;
    achievementsData.achievements.forEach(a => achievementMap.set(a.achievement, a));
    allAchievementTypes = [...new Set(achievementsData.achievements.map(a => a.type))].sort();

    setupCountryFlags(allPlayers);
    setupAchievementTypeFilter(allAchievementTypes);
    renderFilteredPlayers();
  } catch (error) {
    console.error("❌ Failed to load player or achievement data:", error);
  }
}

  document.addEventListener("DOMContentLoaded", fetchAndRenderPlayers);
</script>
