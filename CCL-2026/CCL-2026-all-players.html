<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- СТИЛІ -->
<style>
  :root {
    --main-bg-color: #A47864;
    --hover-bg-color: #8F6553;
    --accent-text-color: #fff;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: 'Montserrat', sans-serif;
  }

  .group-section {
    margin: 5px 0;
  }

  .group-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 3px;
    color: #222;
  }

  .players-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .players-count {
    margin: 0;
  }

  .players-filters {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .filter-label {
    font-size: 12px;
    font-weight: 600;
    color: #333;
  }

  .filter-chip-group {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .filter-chip {
    border: 1px solid #8F6553;
    background-color: #fff;
    color: #8F6553;
    border-radius: 2px;
    padding: 1px 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .filter-chip.active {
    background-color: #8F6553;
    color: #fff;
  }

  .filter-chip:hover {
    background-color: #7A5746;
    color: #fff;
  }

  .group-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
    border-radius: 2px;
    box-shadow: 1.4px 1.4px 2px #b2b2b2;
    overflow: hidden;
  }

  .group-table th {
    background-color: var(--main-bg-color);
    color: var(--accent-text-color);
    font-weight: 600;
    padding: 6px;
    font-size: 15px;
    text-align: center;
  }

  .group-table tr:first-child th:nth-child(2) {
    text-align: left;
  }

  .group-table th.player-col,
  .group-table td.player-col {
    width: 1%;
    min-width: 160px;
    white-space: nowrap;
  }

  .group-table th.qualified-cell,
  .group-table td.qualified-cell {
    width: 28%;
    max-width: 220px;
  }

  .qualified-wrap {
    display: block;
    width: 100%;
    max-width: 220px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 480px) {
    .group-table th.qualified-cell,
    .group-table td.qualified-cell {
      display: none;
    }
  }

  .group-table td {
    padding: 6px;
    font-size: 15px;
    line-height: 17px;
    border-top: 1px solid #ccc;
    text-align: center;
    background-color: #fff;
  }

  .group-table td a {
    color: #333;
    text-decoration: none;
    word-break: break-word;
  }

  .group-table td a:hover {
    color: #0277BD;
  }

  .players-name-wrap {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 2px 7px;
    flex-wrap: wrap;
    align-content: flex-start;
    width: 100%;
  }

  .country-wrap {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 2px 7px;
    flex-wrap: wrap;
    align-content: flex-start;
    width: 100%;
  }

  .players-name-wrap a {
    flex: 1 1 auto;
    min-width: 0;
    max-width: 100%;
  }

  .players-name-wrap span {
    flex: 1 1 auto;
    min-width: 0;
    max-width: 100%;
  }

  .country-flag {
    height: 18px;
    width: 22px;
    object-fit: cover;
  }

  .seeding-icon {
    width: 10px;
    height: auto;
    margin-left: 4px;
    display: inline-block;
  }

  .seeding-legend {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    margin-top: 6px;
    color: #333;
  }

  .seeding-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .country-wrap span {
    flex: 1 1 auto;
    min-width: 0;
    max-width: 100%;
    word-break: break-word;
    white-space: pre-line;
  }

  .player-logo {
    height: 18px;
    width: 18px;
    border: 0.5px solid #444;
    object-fit: contain;
    border-radius: 2px;
    vertical-align: middle;
  }

  .elo-comment {
    margin-top: 12px;
    font-size: 14px;
    line-height: 1.4;
  }
</style>

<!-- HTML -->
<div id="tab-players-content"></div>

<!-- СКРИПТ -->
<script>
  
  // --- TOURNAMENT ID ---
  // Determine currentTournamentId either from test default or from the page URL
  const currentTournamentId = "CCL-2026Q";
  let players = [];
  let tournament_players = [];
  let tournaments = [];
  let countries = [];
  const PLAYER_STAGE_FILTERS = ["Main", "Q1", "Q2", "Q3", "Q4"];
  const playersFilterState = {
    registeredOnly: false,
    stages: new Set()
  };

  function fetchTournamentsAndInit() {
    const dataUrl = "https://zaharik-ua.github.io/carcassonne-gg/json-data/tournaments-done/CCL-2026Q.json";

    fetch(dataUrl)
      .then(r => {
        if (!r.ok) throw new Error("Failed to fetch data");
        return r.json();
      })
      .then(data => {
        if (!data || !data.tournaments || !Array.isArray(data.tournaments)) {
          const playersContainer = document.getElementById("tab-players-content");
          if (playersContainer) {
            playersContainer.textContent = "❌ Failed to load tournament data";
          }
          return;
        }

        // Збереження відповідних частин даних
        players = data.players || [];
        tournament_players = data.tournament_players || [];
        tournaments = data.tournaments || [];
        countries = data.countries || [];
        initAndRenderTournamentContent();
      })
      .catch(err => {
        console.error("❌ Failed to load tournament data", err);
        const playersContainer = document.getElementById("tab-players-content");
        if (playersContainer) {
          playersContainer.textContent = "❌ Failed to load tournament data";
        }
      });
  }

  function initAndRenderTournamentContent() {
    const playersContainer = document.getElementById("tab-players-content");
    if (playersContainer) {
      playersContainer.style.display = "block";
      renderPlayersTable();
    }

    return;
  }

  function renderPlayersTable() {
    const playersContainer = document.getElementById("tab-players-content");
    if (!playersContainer) return;

    playersContainer.innerHTML = "";

    const tp = (tournament_players || []).filter(p => {
      if (p.tournament_id !== currentTournamentId) return false;
      const playerName = (p.player || "").trim().toLowerCase();
      if (playerName.startsWith("test")) return false;
      return true;
    });
    if (!tp.length) {
      playersContainer.textContent = "No registered players yet.";
      return;
    }

    const sorted = [...tp].sort((a, b) => {
      const countryCompare = (a.country || "").localeCompare(b.country || "", undefined, { sensitivity: "base" });
      if (countryCompare !== 0) return countryCompare;

      const stageCompare = (a.stage || "").localeCompare(b.stage || "", undefined, { sensitivity: "base" });
      if (stageCompare !== 0) return stageCompare;

      return (a.player || "").localeCompare(b.player || "", undefined, { sensitivity: "base" });
    });

    const filtered = sorted.filter(entry => {
      if (playersFilterState.registeredOnly && !(entry.player || "").trim()) {
        return false;
      }
      const hasStageFilter = playersFilterState.stages.size > 0;
      const stageValue = (entry.stage || "").trim();
      if (!hasStageFilter) {
        return true;
      }
      if (PLAYER_STAGE_FILTERS.includes(stageValue)) {
        return playersFilterState.stages.has(stageValue);
      }
      return false;
    });

    const totalCount = sorted.length;
    const visibleCount = filtered.length;

    const section = document.createElement("div");
    section.className = "group-section";

    const headerRow = document.createElement("div");
    headerRow.className = "players-header-row";

    const title = document.createElement("div");
    title.className = "group-title players-count";
    title.textContent = totalCount === visibleCount
      ? `Players: ${visibleCount}`
      : `Players: ${visibleCount} / ${totalCount}`;
    headerRow.appendChild(title);

    const filtersWrapper = document.createElement("div");
    filtersWrapper.className = "players-filters";

    const registeredGroup = document.createElement("div");
    registeredGroup.className = "filter-group";
    const registeredButton = document.createElement("button");
    registeredButton.type = "button";
    registeredButton.className = "filter-chip" + (playersFilterState.registeredOnly ? " active" : "");
    registeredButton.textContent = "Registered";
    registeredButton.setAttribute("aria-pressed", playersFilterState.registeredOnly ? "true" : "false");
    registeredButton.addEventListener("click", () => {
      playersFilterState.registeredOnly = !playersFilterState.registeredOnly;
      renderPlayersTable();
    });
    registeredGroup.appendChild(registeredButton);
    filtersWrapper.appendChild(registeredGroup);

    const stageGroup = document.createElement("div");
    stageGroup.className = "filter-group";
    const stageLabel = document.createElement("span");
    stageLabel.className = "filter-label";
    stageLabel.textContent = "Stage:";
    stageGroup.appendChild(stageLabel);

    const stageButtonsWrap = document.createElement("div");
    stageButtonsWrap.className = "filter-chip-group";
    PLAYER_STAGE_FILTERS.forEach(stageOption => {
      const isActive = playersFilterState.stages.has(stageOption);
      const stageBtn = document.createElement("button");
      stageBtn.type = "button";
      stageBtn.className = "filter-chip" + (isActive ? " active" : "");
      stageBtn.textContent = stageOption;
      stageBtn.setAttribute("aria-pressed", isActive ? "true" : "false");
      stageBtn.addEventListener("click", () => {
        if (playersFilterState.stages.has(stageOption)) {
          playersFilterState.stages.delete(stageOption);
        } else {
          playersFilterState.stages.add(stageOption);
        }
        renderPlayersTable();
      });
      stageButtonsWrap.appendChild(stageBtn);
    });
    stageGroup.appendChild(stageButtonsWrap);
    filtersWrapper.appendChild(stageGroup);

    headerRow.appendChild(filtersWrapper);
    section.appendChild(headerRow);

    const table = document.createElement("table");
    table.className = "group-table";

    const headTr = document.createElement("tr");
    ["Country", "Player", "Elo *", "Qualified by", "Stage"].forEach(label => {
      const th = document.createElement("th");
      th.textContent = label;
      if (label === "Player" || label === "Qualified by" || label === "Country") {
        th.style.textAlign = "left";
      }
      if (label === "Player") {
        th.classList.add("player-col");
      }
      if (label === "Qualified by") {
        th.classList.add("qualified-cell");
      }
      th.style.backgroundColor = "#A47864";
      th.style.color = "#ffffff";
      headTr.appendChild(th);
    });
    table.appendChild(headTr);

    if (!filtered.length) {
      const emptyRow = document.createElement("tr");
      const emptyCell = document.createElement("td");
      emptyCell.colSpan = 5;
      emptyCell.style.textAlign = "center";
      emptyCell.style.padding = "12px";
      emptyCell.textContent = "No players match filters.";
      emptyRow.appendChild(emptyCell);
      table.appendChild(emptyRow);
      section.appendChild(table);
      playersContainer.appendChild(section);
      return;
    }

    const countryCounts = filtered.reduce((acc, entry) => {
      const key = entry.country || "";
      acc[key] = (acc[key] || 0) + 1;
      return acc;
    }, {});
    const countryUsage = {};

    filtered.forEach(entry => {
      const tr = document.createElement("tr");

      const countryKey = entry.country || "";
      countryUsage[countryKey] = (countryUsage[countryKey] || 0) + 1;

      if (countryUsage[countryKey] === 1) {
        const countryTd = document.createElement("td");
        countryTd.style.padding = "4px 6px";
        countryTd.style.textAlign = "left";
        countryTd.style.verticalAlign = "middle";
        const countryWrap = document.createElement("div");
        countryWrap.className = "country-wrap";
        const countryName = entry.country || "";
        if (countryName) {
          const countryObject = (countries || []).find(c => c.team === countryName);
          if (countryObject && countryObject.flag) {
            const flagImg = document.createElement("img");
            flagImg.src = countryObject.flag;
            flagImg.className = "country-flag";
            flagImg.alt = countryName;
            countryWrap.appendChild(flagImg);
          }
          const countrySpan = document.createElement("span");
          countrySpan.textContent = countryName;
          countryWrap.appendChild(countrySpan);
        } else {
          countryWrap.textContent = "-";
        }
        countryTd.appendChild(countryWrap);
        const rowspan = countryCounts[countryKey] || 1;
        countryTd.rowSpan = rowspan;
        tr.appendChild(countryTd);
      }

      const playerTd = document.createElement("td");
      playerTd.style.textAlign = "left";
      playerTd.style.padding = "4px 6px";
      playerTd.classList.add("player-col");
      const playerWrap = document.createElement("div");
      playerWrap.className = "players-name-wrap";
      const playerObj = (players || []).find(pl => pl.player_id === entry.player_id);
      if (playerObj && playerObj.avatar) {
        const avatarImg = document.createElement("img");
        avatarImg.src = playerObj.avatar;
        avatarImg.className = "player-logo";
        avatarImg.alt = entry.player || "";
        playerWrap.appendChild(avatarImg);
      }
      if (entry.player_id || entry.player) {
        const playerLink = document.createElement("a");
        playerLink.href = `https://boardgamearena.com/player?id=${entry.player_id}`;
        playerLink.target = "_blank";
        playerLink.rel = "noopener";
        playerLink.textContent = entry.player || "";
        playerWrap.appendChild(playerLink);
      }
      playerTd.appendChild(playerWrap);
      tr.appendChild(playerTd);

      const eloTd = document.createElement("td");
      eloTd.style.textAlign = "center";
      if (entry.elo !== undefined && entry.elo !== null && entry.elo !== "") {
        const eloValue = document.createElement("span");
        eloValue.textContent = entry.elo;
        eloTd.appendChild(eloValue);

        const seedingStatus = typeof entry.seeding === "string" ? entry.seeding.trim() : entry.seeding;
        if (seedingStatus === "Seeded" || seedingStatus === "Unseeded") {
          const seedingIcon = document.createElement("img");
          seedingIcon.src = seedingStatus === "Seeded"
            ? "https://carcassonne.gg/gallery/green-dot.png"
            : "https://carcassonne.gg/gallery/red-dot.png";
          seedingIcon.alt = `${seedingStatus} status icon`;
          seedingIcon.className = "seeding-icon";
          eloTd.appendChild(seedingIcon);
        }
      }
      tr.appendChild(eloTd);

      const qualifiedTd = document.createElement("td");
      qualifiedTd.style.textAlign = "left";
      qualifiedTd.style.padding = "4px 6px";
      qualifiedTd.classList.add("qualified-cell");
      const qualifiedWrap = document.createElement("div");
      qualifiedWrap.className = "qualified-wrap";
      const qualifiedName = entry.qualified_by_name || "";
      const qualifiedLink = entry.qualified_by_link || "";
      if (qualifiedName) {
        if (qualifiedLink) {
          const qualifiedAnchor = document.createElement("a");
          qualifiedAnchor.href = qualifiedLink;
          if (!qualifiedLink.includes("carcassonne.gg")) {
            qualifiedAnchor.target = "_blank";
            qualifiedAnchor.rel = "noopener";
          }
          qualifiedAnchor.textContent = qualifiedName;
          qualifiedWrap.appendChild(qualifiedAnchor);
        } else {
          qualifiedWrap.textContent = qualifiedName;
        }
      } else if (qualifiedLink) {
        const qualifiedAnchor = document.createElement("a");
        qualifiedAnchor.href = qualifiedLink;
        if (!qualifiedLink.includes("carcassonne.gg")) {
          qualifiedAnchor.target = "_blank";
          qualifiedAnchor.rel = "noopener";
        }
        qualifiedAnchor.textContent = qualifiedLink;
        qualifiedWrap.appendChild(qualifiedAnchor);
      } else {
        qualifiedWrap.textContent = "-";
      }
      qualifiedTd.appendChild(qualifiedWrap);
      tr.appendChild(qualifiedTd);

      const stageTd = document.createElement("td");
      stageTd.textContent = entry.stage || "-";
      tr.appendChild(stageTd);

      table.appendChild(tr);
    });

    section.appendChild(table);
    playersContainer.appendChild(section);

    const tournament = (tournaments || []).find(t => t.tournament_id === currentTournamentId);
    const eloComment = (tournament && tournament.elo_comment) ? String(tournament.elo_comment).trim() : "";
    if (eloComment) {
      const commentBlock = document.createElement("div");
      commentBlock.className = "elo-comment";
      commentBlock.textContent = eloComment;
      playersContainer.appendChild(commentBlock);
    }

    const legendBlock = document.createElement("div");
    legendBlock.className = "seeding-legend";

    const makeLegendItem = (iconSrc, text, altText) => {
      const item = document.createElement("div");
      item.className = "seeding-legend-item";
      const icon = document.createElement("img");
      icon.src = iconSrc;
      icon.alt = altText;
      icon.className = "seeding-icon";
      icon.style.marginLeft = "0";
      const label = document.createElement("span");
      label.textContent = text;
      item.appendChild(icon);
      item.appendChild(label);
      return item;
    };

    legendBlock.appendChild(makeLegendItem("https://carcassonne.gg/gallery/green-dot.png", "Seeded", "Seeded icon"));
    legendBlock.appendChild(makeLegendItem("https://carcassonne.gg/gallery/red-dot.png", "Unseeded", "Unseeded icon"));

    playersContainer.appendChild(legendBlock);
  }

  document.addEventListener("DOMContentLoaded", () => {
    fetchTournamentsAndInit();
  });

</script>
